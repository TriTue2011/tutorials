blueprint:
  name: Voice - Send to Zalo
  author: VuLQ
  description: >-
    # Tool for sending content to Zalo using LLM

    ## Blueprint Setup

    ### Required

    * The Zalo Bot integration must be installed through HACS and properly configured.

    ### Optional

    * Adjust the prompts for each field used in the script. The descriptions guide the LLM to provide the correct input.

    ### Note

    * Provide a concise and precise description for the script. This will be utilized by the LLM to understand it should use this script for sending user requested content to Zalo.

    * Make sure to expose the script to Assist after the script has been saved.

    * Do not alter the default script name.
  domain: script
  homeassistant:
    min_version: 2024.10.0
  input:
    zalo_settings:
      name: Settings for Zalo
      icon: mdi:alpha-z-circle-outline
      description: You can use these settings to configure Zalo for sending the message.
      input:
        account:
          name: Account
          description: The account (phone number) to send the message.
          selector:
            text:
        thread_id:
          name: Thread ID
          description: The thread to send the message to.
          selector:
            text:
        receiver:
          name: Type of Receiver
          description: The type of receiver to send the message to.
          selector:
            select:
              options:
                - label: User
                  value: "0"
                - label: Group
                  value: "1"
          default: "0"
    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: You can use these settings to finetune the prompts for your specific LLM (model). In most cases the defaults should be fine.
      collapsed: true
      input:
        summary_prompt:
          name: Summary Prompt
          description: The prompt which will be used for the LLM can provide the message summary.
          selector:
            text:
              multiline: true
          default: >-
            This argument is mandatory and must always be provided.

            Provide a brief overview, such as the name of a person, object, or location title.
            No extra commentary, no markdown or emojis.
            Return only the title text.

            When submitting multiple items, make sure each one must be sent separately through a separate tool call.
        detail_prompt:
          name: Detail Prompt
          description: The prompt which will be used for the LLM can provide the message detail.
          selector:
            text:
              multiline: true
          default: >-
            This argument is optional.

            Provide clear and specific details, such as comprehensive information or a detailed description of the subject.
            No links, no markdown/emojis, no additional commentary.
            Return only the detail text.

            When submitting multiple items, make sure each one must be sent separately through a separate tool call.
        content_type_prompt:
          name: Content Type Prompt
          description: The prompt which will be used for the LLM can specify the type of content for the message.
          selector:
            text:
              multiline: true
          default: >-
            This argument is mandatory and must always be provided.

            Return exactly one of the following options: information, location.
            Return only the word, without quotes or extra text.

            Choose location for any place/address/directions/map intent.
            Do not choose information in these cases.

            Otherwise choose information.

            When submitting multiple items, make sure each one must be sent separately through a separate tool call.
        location_prompt:
          name: Location Prompt
          description: The prompt which will be used for the LLM can provide the location for the place.
          selector:
            text:
              multiline: true
          default: >-
            This argument is optional. Use only when content_type is location.

            Return the address of the location. Names only; no commas, prefixes or punctuation; single spaces.

            If content_type = information: leave this blank.

            Return only the value.
mode: queued
max: 30
max_exceeded: silent
fields:
  summary:
    name: Summary
    description: !input summary_prompt
    selector:
      text:
    required: true
  detail:
    name: Detail
    description: !input detail_prompt
    selector:
      text:
  content_type:
    name: Content Type
    description: !input content_type_prompt
    selector:
      select:
        options:
          - information
          - location
    required: true
  location:
    name: Location
    description: !input location_prompt
    selector:
      text:
sequence:
  - variables:
      version: 20250915
      summary: "{{ summary | default('') | trim }}"
      detail: "{{ detail | default('') | trim }}"
      content_type: "{{ content_type | default('') | trim }}"
      location: "{{ location | default('') | trim }}"
  - alias: Check if variables were set correctly
    if:
      - condition: template
        value_template: >-
          {{
            (not summary)
            or (content_type not in ['information', 'location'])
            or (content_type == 'location' and not location)
          }}
    then:
      - alias: Set variable for error message
        variables:
          response:
            error: >-
              Unable to send the message to Zalo because one or more
              inputs are missing or invalid (summary, content_type, or location).
      - alias: Stop the script
        stop: Unable to send the message to Zalo due to invalid inputs.
        response_variable: response
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ content_type == 'information' }}"
        sequence:
          - action: zalo_bot.send_message
            data:
              account_selection: !input account
              thread_id: !input thread_id
              type: !input receiver
              message: >-
                {{ summary }}


                {{ detail }}


                {% set query = summary.split() | join('+') -%}
                {% set url = 'https://www.google.com/search?q=' ~ query -%}
                Google Search ({{ url }})
      - conditions:
          - condition: template
            value_template: "{{ content_type == 'location' }}"
        sequence:
          - action: zalo_bot.send_message
            data:
              account_selection: !input account
              thread_id: !input thread_id
              type: !input receiver
              message: >-
                {{ summary }}


                {{ detail }}


                {% set place = (summary ~ ' ' ~ location).split() | join('+') -%}
                {% set url = 'https://www.google.com/maps/search/?api=1&query=' ~ place -%}
                Google Maps ({{ url }})
